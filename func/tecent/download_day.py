import tools.urltools as urltools
import tools.randomtool as randomtool
import tools.filetool as filetool
import tools.jsontool as jsontool
from const.const import UPDATE_DAY_COLLECT_DIR_JSON
from const.const import UPDATE_DAY_COLLECT_DIR_CSV
import log
import json
import func.stocks as stockapp
from func.day import Day
from func.stock import Stock
import csv
from func.day import day_csv_header


class DownloadDayOnStock:
    # https://proxy.finance.qq.com/ifzqgtimg/appstock/app/newkline/newkline?_var=kline_day&param=sz002230,day,2025-01-01,2025-12-31,320,&r=0.8343595718071068
    # url = f'https://proxy.finance.qq.com/ifzqgtimg/appstock/app/newkline/newkline?_var=kline_day&param=sz002230,day,,,320,&r=0.3090699758740716'

    def __init__(self, is_delete_dir=True):
        self._is_delete_org_json = is_delete_dir
        self._local_dir = f'{UPDATE_DAY_COLLECT_DIR_JSON}'
        self._start_date_str = ''
        self._end_date_str = ''

    def _day_url(self, stock, start_date_str='', end_date_str=''):
        _typeCode = f'{stock.read_type()}{stock.read_code()}'
        return f'https://proxy.finance.qq.com/ifzqgtimg/appstock/app/newkline/newkline?_var=kline_day&param={_typeCode},day,{start_date_str},{end_date_str},320,&r={randomtool.random16()}'

    def do_work(self, stock: Stock):
        """开始运行的入口"""
        if not filetool.create_folder_if_not_exists(self._local_dir):
            log.error(f'DownloadDay 创建工作目录 {self._local_dir} 错误')
            return

        _code = stock.read_code()
        _type = stock.read_type()
        _name = stock.read_name()
        _typeCode = f'{_type}{_code}'
        # 是否删除之前现在的文件
        json_file_path = f'{self._local_dir}/{_typeCode}.json'

        if self._is_delete_org_json:
            filetool.remove_file(json_file_path)
        if filetool.is_file_exits(json_file_path):
            log.info('文件已经存在，不向下执行.')
            return

        _url = self._day_url(stock)
        log.info(f'DownloadDayOnStock _url={_url}')
        read_url_data = urltools.read_url(_url)
        str_json_data = read_url_data.split('=', 1)[1]
        json_data = json.loads(str_json_data)
        if not jsontool.is_json_validate(json_data):
            log.error(f'非法的json数据. url={_url}, json:{json_data}')
            return
        filetool.save_json_data(json_file_path, json_data)


class KLineDayJsonOp:
    # {"code":0,"msg":"","data":{"sz002230":{"day":[["2023-11-08","48.38","48.60","48.99","47.80","582338.00",{},"2.74","282215.80","0.00","0.00"],["2023-11-09","49.00","48.51","49.56","47.98","449757.00",{},"2.11","218558.96","0.00","0.00"],["2023-11-10","48.08","47.40","48.27","47.27","366633.00",{},"1.72","174470.29","0.00","0.00"],["2023-11-13","48.35","49.64","50.77","47.82","822619.00",{},"3.87","408242.92","0.00","0.00"],["2023-11-14","49.96","49.91","50.35","49.01","509443.00",{},"2.39","252892.84","0.00","0.00"],["2023-11-15","50.92","50.40","51.86","50.10","590306.00",{},"2.77","299572.81","0.00","0.00"],["2023-11-16","49.97","49.26","50.30","49.23","364811.00",{},"1.71","181183.31","0.00","0.00"],["2023-11-17","49.00","49.20","49.76","48.66","335447.00",{},"1.58","164552.25","0.00","0.00"],["2023-11-20","49.17","49.67","50.19","48.81","418714.00",{},"1.97","207508.91","0.00","0.00"],["2023-11-21","49.69","48.99","50.05","48.72","340899.00",{},"1.60","168169.68","0.00","0.00"],["2023-11-22","48.67","47.80","48.90","47.80","305045.00",{},"1.43","147289.31","0.00","0.00"],["2023-11-23","48.35","47.89","48.50","46.81","287829.00",{},"1.35","136850.63","0.00","0.00"],["2023-11-24","48.37","46.38","48.47","45.88","455589.00",{},"2.14","212367.25","0.00","0.00"],["2023-11-27","45.76","45.71","46.27","45.50","295062.00",{},"1.39","134955.47","0.00","0.00"],["2023-11-28","45.69","45.68","45.81","45.15","234448.00",{},"1.10","106578.44","0.00","0.00"],["2023-11-29","45.65","45.06","45.77","44.90","257627.00",{},"1.21","116550.08","0.00","0.00"],["2023-11-30","44.88","44.75","45.18","44.34","256239.00",{},"1.19","114626.23","0.00","0.00"],["2023-12-01","44.73","47.18","47.77","44.45","662375.00",{},"3.09","306595.32","0.00","0.00"],["2023-12-04","47.17","47.27","48.06","46.72","445980.00",{},"2.08","211869.68","0.00","0.00"],["2023-12-05","46.83","45.45","47.07","45.41","350728.00",{},"1.64","161628.80","0.00","0.00"],["2023-12-06","45.40","45.38","45.92","44.91","286177.00",{},"1.33","129724.24","0.00","0.00"],["2023-12-07","45.38","47.08","47.99","45.20","639877.00",{},"2.98","298695.85","0.00","0.00"],["2023-12-08","47.30","48.45","49.46","46.85","772790.00",{},"3.60","371594.91","0.00","0.00"],["2023-12-11","47.98","49.66","49.95","47.64","639775.00",{},"2.98","312880.71","0.00","0.00"],["2023-12-12","49.40","49.49","50.00","49.00","434160.00",{},"2.02","214685.49","0.00","0.00"],["2023-12-13","49.50","48.90","50.12","48.88","429829.00",{},"2.00","212835.32","0.00","0.00"],["2023-12-14","49.22","48.90","50.11","48.87","407175.00",{},"1.90","201254.41","0.00","0.00"],["2023-12-15","49.18","48.34","49.38","47.84","330429.00",{},"1.53","160100.04","0.00","0.00"],["2023-12-18","48.00","47.33","48.45","47.17","299644.00",{},"1.39","143015.53","0.00","0.00"],["2023-12-19","47.26","48.18","48.68","46.89","312093.00",{},"1.45","149578.78","0.00","0.00"],["2023-12-20","48.14","46.33","48.25","46.30","329693.00",{},"1.53","154719.51","0.00","0.00"],["2023-12-21","45.99","47.13","47.66","45.99","296927.00",{},"1.38","139445.14","0.00","0.00"],["2023-12-22","46.94","45.96","47.25","45.67","321622.00",{},"1.49","148819.45","0.00","0.00"],["2023-12-25","46.11","46.64","47.60","45.88","278241.00",{},"1.29","129874.53","0.00","0.00"],["2023-12-26","46.43","45.17","46.48","44.81","305062.00",{},"1.42","138073.61","0.00","0.00"],["2023-12-27","45.21","45.05","45.38","44.73","258636.00",{},"1.20","116493.45","0.00","0.00"],["2023-12-28","45.01","46.05","46.30","44.27","408946.00",{},"1.90","186035.83","0.00","0.00"],["2023-12-29","46.05","46.38","46.66","45.91","333603.00",{},"1.55","154540.07","0.00","0.00"],["2024-01-02","46.35","45.10","46.43","45.06","308237.00",{},"1.43","140269.78","0.00","0.00"],["2024-01-03","45.00","43.28","45.05","42.67","575936.00",{},"2.67","251370.47","0.00","0.00"],["2024-01-04","43.00","41.70","43.10","41.54","474301.00",{},"2.20","198979.71","0.00","0.00"],["2024-01-05","41.87","40.94","41.91","40.65","367020.00",{},"1.70","151501.84","0.00","0.00"],["2024-01-08","40.82","40.01","40.98","39.96","307401.00",{},"1.43","123702.63","0.00","0.00"],["2024-01-09","40.01","40.16","40.50","39.70","300641.00",{},"1.40","120461.37","0.00","0.00"],["2024-01-10","40.00","39.40","40.30","38.78","345121.00",{},"1.60","136323.16","0.00","0.00"],["2024-01-11","39.40","40.82","41.08","39.40","438256.00",{},"2.03","177511.89","0.00","0.00"],["2024-01-12","40.60","40.19","40.85","40.10","249801.00",{},"1.16","101121.08","0.00","0.00"],["2024-01-15","40.00","39.88","40.80","39.65","267712.00",{},"1.24","107496.99","0.00","0.00"],["2024-01-16","39.80","39.95","39.95","39.13","302578.00",{},"1.40","119531.34","0.00","0.00"],["2024-01-17","40.13","39.18","40.19","39.18","252502.00",{},"1.17","100195.83","0.00","0.00"],["2024-01-18","38.88","40.02","40.06","38.48","431382.00",{},"2.00","168776.56","0.00","0.00"],["2024-01-19","39.86","39.35","40.18","39.20","260352.00",{},"1.21","103386.44","0.00","0.00"],["2024-01-22","39.90","38.28","39.99","37.89","377258.00",{},"1.75","147333.11","0.00","0.00"],["2024-01-23","38.10","42.11","42.11","37.87","1051423.00",{},"4.88","429983.16","0.00","0.00"],["2024-01-24","41.73","42.40","42.46","40.87","780554.00",{},"3.62","326250.98","0.00","0.00"],["2024-01-25","41.97","42.60","42.90","41.34","671274.00",{},"3.12","283355.20","0.00","0.00"],["2024-01-26","42.19","41.84","42.72","41.79","452405.00",{},"2.10","190560.05","0.00","0.00"],["2024-01-29","41.83","40.41","42.08","40.40","443200.00",{},"2.06","181396.37","0.00","0.00"],["2024-01-30","41.29","41.14","43.20","40.91","743988.00",{},"3.45","312771.97","0.00","0.00"],["2024-01-31","41.87","38.40","42.00","38.30","700804.00",{},"3.25","277227.31","0.00","0.00"],["2024-02-01","37.91","40.99","42.24","37.40","974076.00",{},"4.52","397441.70","0.00","0.00"],["2024-02-02","40.88","39.90","41.45","38.73","712504.00",{},"3.31","285413.12","0.00","0.00"],["2024-02-05","39.60","39.49","41.38","38.29","757351.00",{},"3.51","302606.09","0.00","0.00"],["2024-02-06","38.05","41.20","41.67","38.01","769511.00",{},"3.57","308309.59","0.00","0.00"],["2024-02-07","41.50","42.00","42.58","40.60","708141.00",{},"3.29","297032.56","0.00","0.00"],["2024-02-08","42.52","43.55","43.88","42.20","698328.00",{},"3.24","301484.75","0.00","0.00"],["2024-02-19","45.90","46.54","46.95","44.70","1030550.00",{},"4.78","473569.67","0.00","0.00"],["2024-02-20","45.96","45.46","46.10","45.20","619155.00",{},"2.87","282468.89","0.00","0.00"],["2024-02-21","44.66","45.02","45.95","44.42","565546.00",{},"2.62","255877.08","0.00","0.00"],["2024-02-22","45.89","46.35","47.59","45.89","840054.00",{},"3.90","391301.85","0.00","0.00"],["2024-02-23","46.70","46.33","46.78","45.70","534540.00",{},"2.48","246786.08","0.00","0.00"],["2024-02-26","46.98","46.99","47.87","46.21","750913.00",{},"3.44","355238.70","0.00","0.00"],["2024-02-27","46.69","49.82","50.00","46.20","1077871.00",{},"4.93","520540.15","0.00","0.00"],["2024-02-28","49.85","47.60","50.44","47.56","977445.00",{},"4.47","480197.51","0.00","0.00"],["2024-02-29","47.45","49.39","49.56","47.30","767071.00",{},"3.51","374538.21","0.00","0.00"],["2024-03-01","49.87","52.57","53.49","49.80","1257750.00",{},"5.76","646930.19","0.00","0.00"],["2024-03-04","52.57","52.33","53.22","51.51","832111.00",{},"3.81","435446.31","0.00","0.00"],["2024-03-05","52.00","52.51","54.34","51.58","1084180.00",{},"4.96","573389.22","0.00","0.00"],["2024-03-06","52.08","52.06","52.80","51.28","685476.00",{},"3.14","356467.06","0.00","0.00"],["2024-03-07","52.28","50.27","52.66","50.00","714498.00",{},"3.27","365321.97","0.00","0.00"],["2024-03-08","50.33","50.81","51.20","49.82","544176.00",{},"2.49","274398.82","0.00","0.00"],["2024-03-11","50.01","51.49","51.69","49.60","550160.00",{},"2.52","280601.07","0.00","0.00"],["2024-03-12","51.80","50.79","51.93","50.48","505190.00",{},"2.31","257735.70","0.00","0.00"],["2024-03-13","51.20","50.84","51.51","50.60","490043.00",{},"2.24","250300.56","0.00","0.00"],["2024-03-14","50.44","50.16","50.95","49.51","448517.00",{},"2.05","225078.22","0.00","0.00"],["2024-03-15","50.00","50.68","50.78","49.32","464881.00",{},"2.13","232937.42","0.00","0.00"],["2024-03-18","50.88","51.40","51.60","50.37","544375.00",{},"2.49","277883.86","0.00","0.00"],["2024-03-19","51.20","50.50","51.22","50.50","375402.00",{},"1.72","190863.69","0.00","0.00"],["2024-03-20","50.41","51.93","52.76","50.40","833768.00",{},"3.82","432210.62","0.00","0.00"],["2024-03-21","52.00","52.23","54.15","51.69","852757.00",{},"3.90","450863.08","0.00","0.00"],["2024-03-22","51.80","51.08","52.10","50.69","535213.00",{},"2.45","274320.05","0.00","0.00"],["2024-03-25","51.07","49.11","51.51","49.00","612964.00",{},"2.81","308420.04","0.00","0.00"],["2024-03-26","49.00","48.02","49.47","47.60","538763.00",{},"2.47","261612.57","0.00","0.00"],["2024-03-27","48.19","45.85","48.23","45.82","504912.00",{},"2.31","235562.04","0.00","0.00"],["2024-03-28","45.90","49.62","50.38","45.89","928723.00",{},"4.25","452692.59","0.00","0.00"],["2024-03-29","49.46","48.72","49.46","47.90","443484.00",{},"2.03","215190.72","0.00","0.00"],["2024-04-01","49.00","49.53","49.88","48.61","386896.00",{},"1.77","190729.87","0.00","0.00"],["2024-04-02","49.33","48.80","49.40","48.35","295741.00",{},"1.35","144234.67","0.00","0.00"],["2024-04-03","48.55","47.66","48.60","47.19","278378.00",{},"1.27","132750.90","0.00","0.00"],["2024-04-08","47.67","47.00","47.77","46.75","235138.00",{},"1.08","111241.38","0.00","0.00"],["2024-04-09","47.00","47.16","47.24","46.21","244055.00",{},"1.12","114106.14","0.00","0.00"],["2024-04-10","47.16","45.90","47.16","45.53","304672.00",{},"1.39","140293.42","0.00","0.00"],["2024-04-11","45.90","46.41","47.37","45.90","343018.00",{},"1.57","160540.71","0.00","0.00"],["2024-04-12","46.55","46.00","47.25","45.98","262512.00",{},"1.20","121828.42","0.00","0.00"],["2024-04-15","46.00","45.78","46.53","45.25","309591.00",{},"1.42","142205.62","0.00","0.00"],["2024-04-16","45.55","45.58","47.15","45.38","378232.00",{},"1.73","174580.76","0.00","0.00"],["2024-04-17","45.88","47.08","47.14","45.57","427506.00",{},"1.96","199517.90","0.00","0.00"],["2024-04-18","46.70","46.46","47.04","46.01","319031.00",{},"1.46","148345.08","0.00","0.00"],["2024-04-19","45.98","44.60","46.19","44.01","501693.00",{},"2.30","224978.61","0.00","0.00"],["2024-04-22","43.80","44.28","44.49","42.37","318340.00",{},"1.46","139608.44","0.00","0.00"],["2024-04-23","43.16","41.97","43.24","40.74","746061.00",{},"3.42","312568.88","0.00","0.00"],["2024-04-24","42.00","43.42","43.55","41.52","504244.00",{},"2.31","214573.77","0.00","0.00"],["2024-04-25","42.78","42.98","43.28","42.53","278437.00",{},"1.27","119636.20","0.00","0.00"],["2024-04-26","43.00","44.35","44.66","43.00","434628.00",{},"1.99","192345.79","0.00","0.00"],["2024-04-29","44.86","45.51","46.34","44.83","491377.00",{},"2.25","224216.37","0.00","0.00"],["2024-04-30","45.40","45.11","45.96","44.80","307000.00",{},"1.41","139095.82","0.00","0.00"],["2024-05-06","46.20","45.53","46.38","45.28","329708.00",{},"1.51","151108.31","0.00","0.00"],["2024-05-07","45.53","45.60","46.50","45.19","349606.00",{},"1.60","160351.26","0.00","0.00"],["2024-05-08","45.13","44.34","45.15","44.24","251419.00",{},"1.15","112004.23","0.00","0.00"],["2024-05-09","44.36","44.67","44.94","44.21","211639.00",{},"0.97","94365.28","0.00","0.00"],["2024-05-10","44.45","43.75","44.74","43.66","277932.00",{},"1.27","122149.63","0.00","0.00"],["2024-05-13","44.00","44.10","44.78","43.41","266239.00",{},"1.22","117441.55","0.00","0.00"],["2024-05-14","44.74","43.53","44.85","43.37","320658.00",{},"1.47","140340.41","0.00","0.00"],["2024-05-15","43.27","43.00","43.50","42.87","177294.00",{},"0.81","76468.77","0.00","0.00"],["2024-05-16","43.22","42.84","43.46","42.68","273447.00",{},"1.25","117653.06","0.00","0.00"],["2024-05-17","42.70","43.19","43.20","42.40","207566.00",{},"0.95","89080.52","0.00","0.00"],["2024-05-20","43.20","43.60","43.99","43.00","269342.00",{},"1.23","117396.00","0.00","0.00"],["2024-05-21","43.60","43.39","43.74","43.30","166763.00",{},"0.76","72520.90","0.00","0.00"],["2024-05-22","43.59","43.87","44.19","43.08","266788.00",{},"1.22","116680.86","0.00","0.00"],["2024-05-23","43.88","42.65","44.10","42.55","313152.00",{},"1.43","134710.70","0.00","0.00"],["2024-05-24","42.41","41.80","42.79","41.80","237404.00",{},"1.09","100107.01","0.00","0.00"],["2024-05-27","41.81","42.16","42.21","41.28","190878.00",{},"0.87","79518.36","0.00","0.00"],["2024-05-28","42.11","41.14","42.11","41.07","214100.00",{},"0.98","88617.90","0.00","0.00"],["2024-05-29","41.50","41.19","42.20","41.08","194498.00",{},"0.89","80547.51","0.00","0.00"],["2024-05-30","41.18","41.98","42.30","40.70","282638.00",{},"1.29","117825.07","0.00","0.00"],["2024-05-31","41.98","42.20","42.70","41.83","219005.00",{},"1.00","92699.76","0.00","0.00"],["2024-06-03","42.21","42.24","42.50","41.90","167685.00",{},"0.77","70765.21","0.00","0.00"],["2024-06-04","42.25","42.16","42.44","41.58","173031.00",{},"0.79","72515.87","0.00","0.00"],["2024-06-05","42.19","42.35","42.87","42.05","217967.00",{},"1.00","92749.94","0.00","0.00"],["2024-06-06","42.43","41.98","43.15","41.90","276414.00",{},"1.27","117291.25","0.00","0.00"],["2024-06-07","42.08","41.51","42.33","41.00","225033.00",{},"1.03","93423.43","0.00","0.00"],["2024-06-11","41.52","41.81","41.99","40.90","199415.00",{},"0.91","82960.32","0.00","0.00"],["2024-06-12","42.00","42.93","43.30","41.91","343078.00",{},"1.57","147159.24","0.00","0.00"],["2024-06-13","42.90","43.08","43.25","42.55","271277.00",{},"1.24","116644.39","0.00","0.00"],["2024-06-14","43.08","43.40","43.50","42.55","315063.00",{},"1.44","136126.98","0.00","0.00"],["2024-06-17","43.31","42.90","43.48","42.60","276801.00",{},"1.27","119128.49","0.00","0.00"],["2024-06-18","42.92","43.60","44.21","42.85","364726.00",{},"1.67","159542.14","0.00","0.00"],["2024-06-19","43.52","43.04","43.64","43.00","201793.00",{},"0.92","87198.38","0.00","0.00"],["2024-06-20","42.80","42.10","42.94","42.09","230390.00",{},"1.05","97834.88","0.00","0.00"],["2024-06-21","41.94","42.73","42.84","41.61","196852.00",{},"0.90","83329.85","0.00","0.00"],["2024-06-24","42.48","41.48","42.65","41.43","226638.00",{},"1.04","94994.08","0.00","0.00"],["2024-06-25","42.00","41.51","42.57","41.05","219136.00",{},"1.00","91507.70","0.00","0.00"],["2024-06-26","42.20","44.76","45.42","41.82","866613.00",{},"3.97","379411.16","0.00","0.00"],["2024-06-27","44.39","43.14","44.67","43.04","546122.00",{},"2.50","239458.73","0.00","0.00"],["2024-06-28","43.20","42.95","43.46","42.68","483992.00",{},"2.22","208595.85","0.00","0.00"],["2024-07-01","42.84","43.49","43.74","42.40","385529.00",{},"1.76","166762.11","0.00","0.00"],["2024-07-02","43.24","42.83","43.88","42.67","320528.00",{},"1.47","138560.50","0.00","0.00"],["2024-07-03","42.80","42.06","42.83","41.41","277261.00",{},"1.27","116307.06","0.00","0.00"],["2024-07-04","42.17","41.11","42.32","41.11","268954.00",{},"1.23","111927.49","0.00","0.00"],["2024-07-05","41.10","41.20","41.37","40.20","232522.00",{"nd":"2023","fh_sh":"1","djr":"2024-07-04","cqr":"2024-07-05","FHcontent":"10派1元"},"1.06","94936.41","0.00","0.00"],["2024-07-08","40.41","38.70","40.41","38.38","481495.00",{},"2.20","187869.79","0.00","0.00"],["2024-07-09","38.69","39.00","39.10","37.90","399023.00",{},"1.83","154167.61","0.00","0.00"],["2024-07-10","38.94","38.86","39.63","38.63","256943.00",{},"1.18","100623.45","0.00","0.00"],["2024-07-11","39.50","39.25","39.62","39.08","266677.00",{},"1.22","104872.66","0.00","0.00"],["2024-07-12","39.07","38.66","39.23","38.62","242519.00",{},"1.11","94163.79","0.00","0.00"],["2024-07-15","38.62","38.13","38.62","37.90","210184.00",{},"0.96","80239.84","0.00","0.00"],["2024-07-16","38.13","39.01","39.20","37.90","296074.00",{},"1.36","114619.67","0.00","0.00"],["2024-07-17","39.02","38.92","39.60","38.86","231747.00",{},"1.06","90672.62","0.00","0.00"],["2024-07-18","38.49","38.69","38.70","37.70","290127.00",{},"1.33","110792.70","0.00","0.00"],["2024-07-19","38.32","39.30","39.50","38.28","286572.00",{},"1.31","112293.53","0.00","0.00"],["2024-07-22","39.30","39.64","40.18","39.30","297809.00",{},"1.36","118448.13","0.00","0.00"],["2024-07-23","39.50","38.58","39.51","38.58","210049.00",{},"0.96","82103.81","0.00","0.00"],["2024-07-24","38.53","38.34","39.08","38.18","192484.00",{},"0.88","74329.81","0.00","0.00"],["2024-07-25","38.20","38.42","38.71","38.01","154637.00",{},"0.71","59403.60","0.00","0.00"],["2024-07-26","38.47","38.66","38.81","38.23","149650.00",{},"0.69","57644.74","0.00","0.00"],["2024-07-29","38.70","38.61","38.86","38.41","114707.00",{},"0.53","44325.15","0.00","0.00"],["2024-07-30","38.61","38.76","38.79","38.21","133900.00",{},"0.61","51550.54","0.00","0.00"],["2024-07-31","38.69","39.72","39.82","38.57","281583.00",{},"1.29","111135.53","0.00","0.00"],["2024-08-01","39.73","39.26","39.88","39.22","205448.00",{},"0.94","81099.08","0.00","0.00"],["2024-08-02","38.98","38.87","39.49","38.75","157248.00",{},"0.72","61382.61","0.00","0.00"],["2024-08-05","38.40","37.90","39.12","37.88","241014.00",{},"1.10","92406.26","0.00","0.00"],["2024-08-06","38.17","36.42","38.34","35.20","508689.00",{},"2.33","185053.06","0.00","0.00"],["2024-08-07","36.43","36.46","36.85","36.20","218568.00",{},"1.00","79802.53","0.00","0.00"],["2024-08-08","36.11","36.15","36.42","35.54","197056.00",{},"0.90","70870.39","0.00","0.00"],["2024-08-09","36.30","35.90","36.55","35.86","131997.00",{},"0.60","47691.52","0.00","0.00"],["2024-08-12","35.88","34.71","35.89","33.80","331423.00",{},"1.52","115445.78","0.00","0.00"],["2024-08-13","34.80","34.92","35.09","34.50","166094.00",{},"0.76","57700.67","0.00","0.00"],["2024-08-14","34.92","34.67","35.00","34.51","131889.00",{},"0.60","45802.91","0.00","0.00"],["2024-08-15","34.60","34.68","35.24","34.23","213281.00",{},"0.98","74138.00","0.00","0.00"],["2024-08-16","34.67","34.46","34.85","34.41","134645.00",{},"0.62","46580.07","0.00","0.00"],["2024-08-19","34.45","34.51","34.74","34.37","146215.00",{},"0.67","50541.73","0.00","0.00"],["2024-08-20","34.52","34.02","34.64","33.77","170917.00",{},"0.78","58212.26","0.00","0.00"],["2024-08-21","33.97","34.00","34.69","33.50","170425.00",{},"0.78","58282.24","0.00","0.00"],["2024-08-22","34.05","33.08","34.49","33.04","247295.00",{},"1.13","82967.72","0.00","0.00"],["2024-08-23","33.00","33.93","34.05","32.95","250524.00",{},"1.15","84348.35","0.00","0.00"],["2024-08-26","33.94","34.00","34.33","33.81","144815.00",{},"0.66","49268.36","0.00","0.00"],["2024-08-27","33.91","33.33","33.94","33.20","148148.00",{},"0.68","49516.44","0.00","0.00"],["2024-08-28","33.29","33.32","33.50","32.66","154253.00",{},"0.71","51033.33","0.00","0.00"],["2024-08-29","33.05","33.59","33.92","32.99","166260.00",{},"0.76","55843.94","0.00","0.00"],["2024-08-30","33.58","34.39","34.75","33.51","284093.00",{},"1.30","97824.35","0.00","0.00"],["2024-09-02","34.50","33.39","34.53","33.39","200657.00",{},"0.92","67801.07","0.00","0.00"],["2024-09-03","33.40","34.09","34.28","33.31","204156.00",{},"0.93","69297.21","0.00","0.00"],["2024-09-04","33.73","33.88","34.12","33.68","116883.00",{},"0.54","39641.56","0.00","0.00"],["2024-09-05","33.89","34.25","34.45","33.81","143465.00",{},"0.66","49011.78","0.00","0.00"],["2024-09-06","34.35","34.00","34.76","33.89","194246.00",{},"0.89","66768.23","0.00","0.00"],["2024-09-09","33.90","33.66","34.25","33.50","132687.00",{},"0.61","44833.93","0.00","0.00"],["2024-09-10","33.68","34.16","34.43","33.26","167483.00",{},"0.77","56693.31","0.00","0.00"],["2024-09-11","34.13","34.34","34.50","33.96","149483.00",{},"0.68","51289.36","0.00","0.00"],["2024-09-12","34.48","34.08","34.85","34.08","142552.00",{},"0.65","49105.45","0.00","0.00"],["2024-09-13","34.20","33.82","34.40","33.80","130731.00",{},"0.60","44550.76","0.00","0.00"],["2024-09-18","33.83","33.84","33.95","33.41","110519.00",{},"0.51","37185.39","0.00","0.00"],["2024-09-19","34.00","34.58","34.77","33.61","251355.00",{},"1.15","86400.64","0.00","0.00"],["2024-09-20","34.59","34.69","34.78","34.37","183525.00",{},"0.84","63455.62","0.00","0.00"],["2024-09-23","34.69","34.81","35.38","34.63","201317.00",{},"0.92","70432.31","0.00","0.00"],["2024-09-24","34.92","35.85","35.85","34.35","379543.00",{},"1.74","133933.35","0.00","0.00"],["2024-09-25","36.12","36.38","37.46","36.12","480585.00",{},"2.20","176965.59","0.00","0.00"],["2024-09-26","36.38","37.57","37.57","36.18","380436.00",{},"1.74","140653.78","0.00","0.00"],["2024-09-27","38.25","40.40","41.00","38.25","743787.00",{},"3.40","295048.67","0.00","0.00"],["2024-09-30","42.38","44.44","44.44","42.26","1105598.00",{},"5.06","482874.31","0.00","0.00"],["2024-10-08","48.88","48.88","48.88","46.00","1378136.00",{},"6.31","667801.40","0.00","0.00"],["2024-10-09","48.88","46.97","50.14","46.07","1443007.00",{},"6.61","694214.36","0.00","0.00"],["2024-10-10","46.97","44.74","47.70","43.91","947111.00",{},"4.34","429340.00","0.00","0.00"],["2024-10-11","44.38","42.91","44.49","42.38","594852.00",{},"2.72","256828.30","0.00","0.00"],["2024-10-14","42.91","43.65","43.66","42.14","537325.00",{},"2.46","231396.75","0.00","0.00"],["2024-10-15","43.60","43.05","44.75","43.01","542866.00",{},"2.49","238516.28","0.00","0.00"],["2024-10-16","42.24","43.00","43.56","42.06","329358.00",{},"1.51","141252.51","0.00","0.00"],["2024-10-17","43.30","44.40","45.64","43.10","798486.00",{},"3.66","353482.97","0.00","0.00"],["2024-10-18","44.01","45.83","47.51","43.05","1128782.00",{},"5.17","510064.40","0.00","0.00"],["2024-10-21","46.22","46.18","47.00","45.83","956264.00",{},"4.38","444162.84","0.00","0.00"],["2024-10-22","46.00","45.55","46.30","45.12","553430.00",{},"2.53","251692.39","0.00","0.00"],["2024-10-23","45.50","45.58","46.00","45.14","451499.00",{},"2.07","205999.70","0.00","0.00"],["2024-10-24","45.61","44.81","45.75","44.78","376813.00",{},"1.72","169795.86","0.00","0.00"],["2024-10-25","45.45","45.48","45.81","45.17","410539.00",{},"1.88","186651.19","0.00","0.00"],["2024-10-28","45.75","45.65","46.10","45.40","398448.00",{},"1.82","182107.18","0.00","0.00"],["2024-10-29","45.84","45.91","47.42","45.15","810103.00",{},"3.71","375278.25","0.00","0.00"],["2024-10-30","45.60","45.55","46.33","45.00","473838.00",{},"2.17","216067.45","0.00","0.00"],["2024-10-31","45.55","45.95","46.55","44.70","640004.00",{},"2.93","293088.97","0.00","0.00"],["2024-11-01","45.96","44.78","47.19","44.77","604437.00",{},"2.77","275238.75","0.00","0.00"],["2024-11-04","44.44","45.43","46.11","43.74","483510.00",{},"2.21","218090.45","0.00","0.00"],["2024-11-05","45.50","46.79","47.09","45.13","926245.00",{},"4.24","430343.37","0.00","0.00"],["2024-11-06","46.80","47.79","48.89","46.65","1103418.00",{},"5.05","528424.45","0.00","0.00"],["2024-11-07","47.00","48.70","49.40","46.40","1014273.00",{},"4.64","483602.93","0.00","0.00"],["2024-11-08","49.23","48.20","50.40","48.09","1074269.00",{},"4.92","528868.80","0.00","0.00"],["2024-11-11","48.00","51.35","51.82","47.84","1628268.00",{},"7.45","822798.11","0.00","0.00"],["2024-11-12","51.00","49.28","51.20","48.78","1104347.00",{},"5.06","550865.05","0.00","0.00"],["2024-11-13","48.67","54.21","54.21","48.48","2246443.00",{},"10.28","1174073.06","0.00","0.00"],["2024-11-14","54.59","52.69","55.15","52.40","1951146.00",{},"8.93","1052929.58","0.00","0.00"],["2024-11-15","52.98","53.07","56.50","52.94","1899286.00",{},"8.69","1038501.99","0.00","0.00"],["2024-11-18","53.98","48.35","54.35","47.76","1654427.00",{},"7.57","820725.78","0.00","0.00"],["2024-11-19","47.30","47.76","48.06","45.61","1289431.00",{},"5.90","604496.28","0.00","0.00"],["2024-11-20","47.79","49.15","49.88","47.47","1046713.00",{},"4.79","513149.84","0.00","0.00"],["2024-11-21","49.00","50.05","51.18","48.19","1012767.00",{},"4.64","505670.78","0.00","0.00"],["2024-11-22","49.70","48.92","52.35","48.70","1332181.00",{},"6.10","676026.28","0.00","0.00"],["2024-11-25","50.15","48.79","50.78","47.01","909115.00",{},"4.16","438896.28","0.00","0.00"],["2024-11-26","48.01","47.04","48.88","47.00","636598.00",{},"2.91","304070.60","0.00","0.00"],["2024-11-27","46.92","48.48","48.50","46.48","658784.00",{},"3.02","312042.96","0.00","0.00"],["2024-11-28","48.50","47.82","49.18","47.77","580748.00",{},"2.66","281182.55","0.00","0.00"],["2024-11-29","47.50","51.31","52.53","47.41","1558442.00",{},"7.14","785654.60","0.00","0.00"],["2024-12-02","51.00","51.15","51.49","50.50","872952.00",{},"4.00","445320.16","0.00","0.00"],["2024-12-03","51.15","49.88","51.39","49.36","769003.00",{},"3.52","385960.86","0.00","0.00"],["2024-12-04","50.07","49.88","50.76","49.41","674582.00",{},"3.09","337503.51","0.00","0.00"],["2024-12-05","49.98","51.30","52.09","49.98","939182.00",{},"4.30","484035.22","0.00","0.00"],["2024-12-06","52.38","51.82","52.93","50.88","877026.00",{},"4.02","455182.34","0.00","0.00"],["2024-12-09","51.84","52.68","54.21","51.84","915822.00",{},"4.19","486152.92","0.00","0.00"],["2024-12-10","54.21","54.51","56.80","52.79","1526412.00",{},"6.99","834555.70","0.00","0.00"],["2024-12-11","53.92","53.21","54.04","52.45","810313.00",{},"3.71","430764.24","0.00","0.00"],["2024-12-12","53.00","52.33","53.80","51.85","733883.00",{},"3.36","385081.75","0.00","0.00"],["2024-12-13","52.00","50.97","52.65","50.86","683698.00",{},"3.13","353643.41","0.00","0.00"],["2024-12-16","51.00","50.50","51.50","50.21","466527.00",{},"2.13","236411.30","0.00","0.00"],["2024-12-17","50.30","49.94","50.91","49.71","439405.00",{},"2.01","220839.97","0.00","0.00"],["2024-12-18","50.01","50.60","51.10","49.61","444090.00",{},"2.03","223934.14","0.00","0.00"],["2024-12-19","50.00","51.59","51.86","49.85","602210.00",{},"2.75","307603.27","0.00","0.00"],["2024-12-20","51.29","51.75","52.50","50.99","603969.00",{},"2.76","312427.06","0.00","0.00"],["2024-12-23","51.77","50.24","51.80","50.15","463239.00",{},"2.12","235313.16","0.00","0.00"],["2024-12-24","50.24","50.28","50.50","49.46","425445.00",{},"1.94","212454.38","0.00","0.00"],["2024-12-25","50.24","49.87","50.94","49.71","356292.00",{},"1.63","178746.06","0.00","0.00"],["2024-12-26","49.87","50.80","51.28","49.77","429539.00",{},"1.96","218123.68","0.00","0.00"],["2024-12-27","50.62","49.96","51.24","49.80","465294.00",{},"2.13","235283.88","0.00","0.00"],["2024-12-30","49.81","50.10","51.00","48.81","472967.00",{},"2.16","236673.64","0.00","0.00"],["2024-12-31","50.10","48.32","50.59","48.30","514301.00",{},"2.35","252159.98","0.00","0.00"],["2025-01-02","48.02","46.30","48.22","46.00","555147.00",{},"2.54","260922.25","0.00","0.00"],["2025-01-03","46.46","44.47","46.62","44.44","524768.00",{},"2.40","237398.07","0.00","0.00"],["2025-01-06","44.40","44.40","45.41","44.02","295708.00",{},"1.35","131644.69","0.00","0.00"],["2025-01-07","44.55","45.21","45.24","44.30","327919.00",{},"1.50","147180.49","0.00","0.00"],["2025-01-08","45.01","45.09","45.50","43.73","428009.00",{},"1.96","191340.44","0.00","0.00"],["2025-01-09","44.98","45.41","46.09","44.82","341013.00",{},"1.56","155308.87","0.00","0.00"],["2025-01-10","45.50","44.80","46.10","44.80","349201.00",{},"1.60","158791.45","0.00","0.00"],["2025-01-13","44.28","45.13","46.00","44.03","407614.00",{},"1.86","184269.40","0.00","0.00"],["2025-01-14","45.25","47.01","47.17","44.89","578147.00",{},"2.64","268218.10","0.00","0.00"],["2025-01-15","47.11","46.49","47.40","46.35","382806.00",{},"1.75","178711.87","0.00","0.00"],["2025-01-16","46.98","48.16","49.81","46.96","873618.00",{},"3.99","424884.22","0.00","0.00"],["2025-01-17","47.77","47.93","48.59","47.66","417413.00",{},"1.91","200591.51","0.00","0.00"],["2025-01-20","48.51","47.81","48.69","47.66","345768.00",{},"1.58","166032.54","0.00","0.00"],["2025-01-21","48.09","48.17","48.29","47.50","348588.00",{},"1.59","167315.80","0.00","0.00"],["2025-01-22","48.20","47.79","48.35","47.68","290339.00",{},"1.33","139330.32","0.00","0.00"],["2025-01-23","48.30","47.36","48.99","47.35","410060.00",{},"1.87","197410.87","0.00","0.00"],["2025-01-24","47.35","49.82","50.49","47.25","894960.00",{},"4.09","440149.80","0.00","0.00"],["2025-01-27","52.18","50.68","52.20","50.10","1041840.00",{},"4.76","531011.11","0.00","0.00"],["2025-02-05","53.00","54.43","55.00","53.00","1600699.00",{},"7.31","866941.23","0.00","0.00"],["2025-02-06","53.39","54.60","54.99","53.01","1120125.00",{},"5.12","607044.36","0.00","0.00"],["2025-02-07","54.49","54.30","55.69","53.45","1342411.00",{},"6.13","733297.40","0.00","0.00"],["2025-02-10","54.87","55.04","55.87","54.22","978136.00",{},"4.47","537957.26","0.00","0.00"],["2025-02-11","54.92","53.91","55.04","53.80","828802.00",{},"3.79","450752.90","0.00","0.00"],["2025-02-12","53.85","54.09","54.50","53.61","591703.00",{},"2.70","319559.52","0.00","0.00"],["2025-02-13","54.09","52.78","54.25","52.60","719033.00",{},"3.28","382781.63","0.00","0.00"],["2025-02-14","52.78","54.58","54.74","52.15","1004087.00",{},"4.59","540183.97","0.00","0.00"],["2025-02-17","55.28","55.05","56.12","54.43","967306.00",{},"4.42","534494.97","0.00","0.00"],["2025-02-18","55.08","53.82","56.50","53.61","841948.00",{},"3.85","462740.37","0.00","0.00"],["2025-02-19","53.90","54.42","54.82","53.39","596209.00",{},"2.72","323819.84","0.00","0.00"],["2025-02-20","54.51","53.62","54.89","53.30","601326.00",{},"2.75","324755.55","0.00","0.00"],["2025-02-21","53.90","55.60","55.98","53.73","1121833.00",{},"5.12","616584.51","0.00","0.00"],["2025-02-24","55.86","57.45","59.37","55.20","1374308.00",{},"6.28","791674.77","0.00","0.00"],["2025-02-25","56.00","55.62","56.70","55.50","843546.00",{},"3.85","472026.16","0.00","0.00"],["2025-02-26","55.67","55.35","55.96","54.74","624580.00",{},"2.85","345112.60","0.00","0.00"],["2025-02-27","55.71","54.32","56.80","53.50","767042.00",{},"3.50","420317.31","0.00","0.00"],["2025-02-28","53.98","51.80","54.33","51.50","774896.00",{},"3.54","407925.56","0.00","0.00"],["2025-03-03","52.10","51.46","52.47","51.07","458009.00",{},"2.09","237572.21","0.00","0.00"],["2025-03-04","51.46","51.60","51.93","51.23","417528.00",{},"1.91","215284.68","0.00","0.00"],["2025-03-05","51.73","51.79","51.95","51.09","378237.00",{},"1.73","194917.99","0.00","0.00"],["2025-03-06","52.53","53.29","53.58","52.41","661543.00",{},"3.02","350924.06","0.00","0.00"]],"qt":{"sz002230":["51","科大讯飞","002230","53.29","51.79","52.53","661543","353111","308432","53.28","650","53.27","573","53.26","214","53.25","497","53.24","66","53.29","3863","53.30","1223","53.31","420","53.32","1238","53.33","277","","20250306161424","1.50","2.90","53.58","52.41","53.29/661543/3509240582","661543","350924","3.02","575.00","","53.58","52.41","2.26","1166.63","1231.92","7.47","56.97","46.61","1.18","-5021","53.05","-268.82","187.42","","","1.29","350924.0582","0.0000","0"," ","GP-A","10.29","-1.90","0.19","1.30","0.36","59.37","32.66","-0.62","-2.40","6.84","2189204280","2311734185","-55.66","27.24","2189103480","","","2.56","0.00","","CNY","0","","53.35","-764"],"market":["2025-03-06 19:31:43|HK_close_已收盘|SH_close_已收盘|SZ_close_已收盘|US_close_未开盘|SQ_close_已休市|DS_close_已休市|ZS_close_已休市|NEWSH_close_已收盘|NEWSZ_close_已收盘|NEWHK_close_已收盘|NEWUS_close_未开盘|REPO_close_已收盘|UK_open_交易中|KCB_close_已收盘|IT_open_交易中|MY_close_已收盘|EU_open_交易中|AH_close_已收盘|DE_open_交易中|JW_close_已收盘|CYB_close_已收盘|USA_close_未开盘|USB_open_盘前交易|ZQ_close_已收盘"],"zjlx":["sz002230","0.00","0.00","0.00","0","0.00","0.00","0.00","0","0.00","0.00","0.00","科大讯飞","20200701","20200701^0.00^0.00","20200630^0.00^0.00","20200629^0.00^0.00","20200624^0.00^0.00","0.00","0.00","20200701085013"]},"mx_price":{"mx":[],"price":[]},"prec":"48.11","fsStartDate":"20201009","version":"16"}}}

    def __init__(self, jsonData):
        self.jsonData = jsonData
        self.days_dict = {}

    def is_json_validate(self):
        return jsontool.is_json_validate(self.jsonData)

    def parse_days_to_dict(self, stock):
        _code = stock.read_code()
        _name = stock.read_name()
        _type = stock.read_type()
        stockCode = f'{_type}{_code}'
        if 'data' not in self.jsonData:
            log.error(f'parse_days_to_dict data not in self.jsonData')
            return self.days_dict
        data = self.jsonData['data']
        if stockCode not in data:
            log.error(f'stockCode not in data')
            return self.days_dict
        json_stockcode = data[stockCode]
        if 'day' not in json_stockcode:
            log.error(f'parse_days_to_dict day not in json_stockcode')
            return self.days_dict
        json_stockcode_day_array = json_stockcode['day']
        for json_stockcode_day in json_stockcode_day_array:
            _day = Day()
            _day.self_kline_json_to_day(json_stockcode_day)
            self.days_dict[_day.get_date()] = _day
        return self.days_dict

    def days_keys(self):
        return list(self.days_dict.keys())

    def days_values(self):
        return list(self.days_dict.values())

    def dict_from_dict(self, date_key: str):
        return self.days_dict[date_key]


class DownloadDays:
    """
    多线程下载json
    """

    def __init__(self):
        self.num_consumers = 1
        self.max_workers = 300
        self.queue_size = 1000
        self.download_day_on_stock = DownloadDayOnStock(is_delete_dir=False)

    def callback(self, stock):
        self.download_day_on_stock.do_work(stock)

    def read_stocks(self):
        """使用生产者消费者模式读取股票CSV文件
        Args:
            callback: 处理每个Stock对象的回调函数
            num_consumers: 消费者线程数量
            max_workers: 线程池最大工作线程数
            queue_size: 队列大小
        """
        stockapp.read_stock_csv(
            lambda stock: self.callback(stock),
            num_consumers=self.num_consumers,
            max_workers=self.max_workers,
            queue_size=self.queue_size
        )

    def startWorkMainThread(self):
        stockapp.read_stock_csv_no_thread(callback=self.callback)

    def startWork(self):
        self.read_stocks()


class DayCsvOp:
    def __init__(self, dayList):
        self.day_list = dayList

    def save_to_local(self, filepath):
        if len(self.day_list) == 0:
            log.error(f'DayCsvOp 操作的dayList is empty. filepath={filepath}')
            return
        with open(filepath, mode='w', newline='') as file:
            writer = csv.writer(file)
            writer.writerow(day_csv_header())
            for _day in self.day_list:
                _row = _day.self_day_csv_row()
                writer.writerow(_row)

    def read_from_local(self, filepath):
        pass


class ConvertJsonToCsv:
    def __init__(self, is_delete_dir=True):
        self.num_consumers = 1
        self.max_workers = 300
        self.queue_size = 1000
        self._is_delete_org_csv = is_delete_dir
        self._local_json_dir = f'{UPDATE_DAY_COLLECT_DIR_JSON}'
        self._local_csv_dir = f'{UPDATE_DAY_COLLECT_DIR_CSV}'

    def callback(self, stock: Stock):
        if not filetool.create_folder_if_not_exists(self._local_csv_dir):
            log.error(f'ConvertJsonToCsv 创建工作目录 {self._local_csv_dir} 错误')
            return
        if not filetool.create_folder_if_not_exists(self._local_json_dir):
            log.error(f'ConvertJsonToCsv 创建工作目录 {self._local_json_dir} 错误')
            return

        _code = stock.read_code()
        _type = stock.read_type()
        _name = stock.read_name()
        log.info(f'{_code}{_type}{_name}')
        _typeCode = f'{_type}{_code}'
        filename = f'{self._local_json_dir}/{_typeCode}.json'
        log.info(f'ConvertJsonToCsv json_file_path={filename}')
        jsonData = jsontool.read_json_file(filename)
        if not jsonData:
            log.error(f'ConvertJsonToCsv错误jsonData={jsonData} filename={filename}')
            return
        kLineDayJsonOp = KLineDayJsonOp(jsonData)
        kLineDayJsonOp.parse_days_to_dict(stock)
        _day_values = kLineDayJsonOp.days_values()

        csvPath = f'{self._local_csv_dir}/{_typeCode}.csv'
        if self._is_delete_org_csv:
            filetool.remove_file(csvPath)
        _dayCsvOp = DayCsvOp(_day_values)
        _dayCsvOp.save_to_local(csvPath)

    def startOneWork(self):
        # self.callback(Stock('300984', '金沃股份', 'sz'))
        stockapp.read_stock_csv_no_thread(callback=self.callback)

    def startWork(self):
        """使用生产者消费者模式读取股票CSV文件
        Args:
            callback: 处理每个Stock对象的回调函数
            num_consumers: 消费者线程数量
            max_workers: 线程池最大工作线程数
            queue_size: 队列大小
        """
        stockapp.read_stock_csv(
            lambda stock: self.callback(stock),
            num_consumers=self.num_consumers,
            max_workers=self.max_workers,
            queue_size=self.queue_size
        )
